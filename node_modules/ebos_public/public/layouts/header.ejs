<!doctype html>
<html lang="<%=: 'lang' | locale %>" id="ebos">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="format-detection" content="telephone=no">
    <link rel="icon" href="favicon.ico">

    <title>e*Profitability</title>
    <link rel="stylesheet" href="/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="/css/dataTables.responsive.css">
    <link rel="stylesheet" href="/css/dataTables.tableTools.css">
    <link rel="stylesheet" href="/css/dataTables.scroller.css">
    <link rel="stylesheet" href="/css/jquery.datetimepicker.css">
    <link rel="stylesheet" href="/css/jquery-ui.min.css" />
    <link rel="stylesheet" href="/css/jquery-ui.theme.min.css" />
    <link rel="stylesheet" href="/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/css/bootstrap-theme.min.css" />
    <link rel="stylesheet" href="/css/toastr.min.css" />
    <link rel="stylesheet" href="/css/chosen.css" />
    <link rel="stylesheet" href="/css/eBos.css" />

    <script src="/js/jquery-1.11.1.min.js"></script>
    <script src="/js/jquery-ui.min.js"></script>
    <script src="/js/jquery.prebind.js"></script>
    <script src="/js/jquery.dataTables.min.js"></script>
    <script src="/js/ebos_dataTables.responsive.js"></script>
    <script src="/js/dataTables.tableTools.js"></script>
    <script src="/js/dataTables.scroller.js"></script>
    <script src="/js/ebos.datetimepicker.js"></script>
    <script src="/js/moment.min.js"></script>
	<script src="/js/bootstrap.min.js"></script>
	<script src="/js/lodash.min.js"></script>
	<script src="/js/globalize/cldr.js"></script>
	<script src="/js/globalize/event.js"></script>
	<script src="/js/globalize/globalize.js"></script>
	<script src="/js/globalize/message.js"></script>
	<script src="/js/globalize/date.js"></script>
	<script src="/js/globalize/number.js"></script>
	<script src="/js/globalize/currency.js"></script>
	<script src="/js/globalize/plural.js"></script>
	<script src="/js/ebos_globalize.js"></script>
	<script src="/js/toastr.min.js"></script>
	<script src="/js/chosen.jquery.js"></script>
	<script src="/js/chosen.order.js"></script>
	<script src="/js/jquery.autocomplete.js"></script>
	<script src="/js/validateFields.js"></script>
	<script src="/js/ebos_validate.js"></script>
	<script src="/js/filters.js"></script>
	<script src="/js/handlers.js"></script>
	<script src="/js/calcs.js"></script>
	<script src="/js/currency_calculator.js"></script>
	<script src="/js/diadem.js"></script>
	<script src="/socket.io/socket.io.js"></script>

	<script>
// Functions used by the page framework
function setLocale(lang) {
	document.cookie='_locale=' + lang + '; max-age=' + 60*60 + '; path=/';
	location.reload();
}

/**
 * Navigation within single-page app
 * @param  {object} options
 * @param  {string} options.url
 * @param  {object} [options.headers] - HTTP headers to send along, X-User-Language and X-Local-Host are set by default
 * @param  {string} [options.method] - HTTP verb to be used
 * @param  {string} [options.name] - Not currently used
 * @return {jQuery Deferred}
 */
function ebos_navigate(options) {
	var promise = $.Deferred();

	var newApi = typeof options === "object";

	if (!newApi && arguments.length < 2) {
		throw new Error("Must provide options object or use historical API");
	}

	var _options = newApi ? options : {};

	if (!newApi) {
		_options.name = arguments[0];
		_options.url = arguments[1];
	}

	var args = {
		method: 'GET',
		headers: {
			'X-User-Language': $('html')[0].lang,
			'X-Local-Host': '<%= AppServer.local_cash_host %>'
		}
	};

	$.extend(true, args, _options);

	$('.lang_selection').hide();    // Hide the language selector

	$.ajax({
		type: args.method,
		url: args.url,
		headers: args.headers,
		success: function(content, testStatus, xhr) {
			// Set app name/version
			var appName = xhr.getResponseHeader('x-ebos-appname');
			var appVersion = xhr.getResponseHeader('x-ebos-appversion');
			$('.app_version').html(appName + ':&nbsp;' + appVersion);

			// Show/Hide sidebar
			/*
			   var sidebar = xhr.getResponseHeader('x-ebos-sidebar');
			   if(sidebar === "false") {
			   $('#sidebar').hide();
			   $('#app_content').removeClass('col-xs-10');
			   $('#app_content').addClass('col-xs-12');
			   } else {
			   $('#sidebar').show();
			   $('#app_content').removeClass('col-xs-12');
			   $('#app_content').addClass('col-xs-10');
			   }
			 */

			ddm.clear();
			$('#app_content').html(content);
			ddm.initValues();

			promise.resolve(args);
		},
		error: function(xhr) {
			handler.error(xhr);
			promise.reject({
				args: args,
				xhr: xhr
			});
		}
	});

	return promise.promise();
}

$(document).ready(function(){

	var local_available = false;
	var local_cash_host='<%= AppServer.local_cash_host %>';
	var cash_host = '<%= AppServer.cash_host %>';
	if(local_cash_host == "null") {
		local_cash_host = null;
		if (cash_host != "null") {
			local_cash_host = cash_host;
		}
	} else {
		local_available = true;
	}

	<%
		// TODO look into some way of automating this (in other
		// words, something like ng-class) -- JK
		%>
		if(local_available) {
			$('.local_cash_link').removeClass('disabled');
			$('.local_qa_link').removeClass('disabled');
			$('.local_safe_link').removeClass('disabled');
			$('.local_log_link').addClass('disabled');
			$("#cash_balance_status").removeClass('hidden');
		} else {
			$('.local_cash_link').addClass('disabled');
			$('.local_qa_link').addClass('disabled');
			$('.local_safe_link').addClass('disabled');
			$('.local_log_link').removeClass('disabled');
			$("#cash_balance_status").addClass('hidden');
		}

	var nsn = '';

	<%
		// FIXME this doesn't fire, and I'm not convinced we even
		// have a situation where this *could* fire. It'd be nice
		// to make this work, either on its own, or as part of the
		// navigation tweaks I discussed with Matt 04 May 2015 -- JK
		%>
		if(location.pathname != '/') {
			// Remember the nsn
			var chunks = location.pathname.split('/');
			nsn = chunks[2];
			$('#nsn').html(nsn);

			// Deal with nsn FOR NOW
			$('.add_nsn').attr("data-toggle","dropdown");
			$('.navbar-right').hide();
		}
		else {
			$('.ebos_url').click(function () {
                    $('#nsn').html(this.innerHTML);
                    $('#app_content').html('');

                    // Deal with nsn FOR NOW
                    $('.add_nsn').attr("data-toggle", "dropdown");
                });
            }

            $('a.local_cash_link').click(function() {
                if(local_available) {
                    ebos_navigate({
                        name:'dcd',
                        url: local_cash_host + '/drawers/' + $('#nsn').html() + '/countdown'
                    });
                }
                else {
                    return false;
                }
            });

            $('a.local_safe_link').click(function() {
                if(local_available) {
                    ebos_navigate({
                        name:'scd',
                        url: local_cash_host + '/safe/' + $('#nsn').html() +'/countdown'
                    });
                }
                else {
                    return false;
                }
            });

            $('a.local_safe_count_link').click(function() {
                ebos_navigate({
                    name:'scd',
                    url: local_cash_host + '/safe_count/' + $('#nsn').html()
                });
            });

            $('a.local_qa_link').click(function() {
                if(local_available) {
                    ebos_navigate({
                        name:'dcd',
                        url: local_cash_host + '/qadatasync/' + $('#nsn').html()
                    });
                }
                else {
                    return false;
                }
            });
            $('a.local_skims_link').click(function() {
                ebos_navigate({
                    name:'skim',
                    url: local_cash_host + '/skim/' + $('#nsn').html() + '/date/' + moment().format("YYYY-MM-DD")
                });
            });

            $('a.local_deposits_link').click(function() {
                ebos_navigate({
                    name:'deposit',
                    url: local_cash_host + '/deposits/' + $('#nsn').html() + '/date/' + moment().format("YYYY-MM-DD")
                });

            });

            $('a.local_crime_losses_link').click(function() {
                ebos_navigate({
                    name: 'crime_loss',
                    url: local_cash_host + '/crime_losses/' + $('#nsn').html()
                });
            });

			$('a.local_cash_controls_link').click(function() {
				ebos_navigate({
					name: 'cash_controls',
					url: local_cash_host + '/cash/' + $('#nsn').html() + '/controls'
				});
			});

			$('a.local_deposit_validation_link').click(function() {
				ebos_navigate({
					name: 'deposit_validation',
					url: local_cash_host + '/cash/' + $('#nsn').html() + '/deposits/validation'
				});
			});

            $('a.local_log_link').click(function() {
				if(local_available) {
                    return false;
                }
                else {
                    ebos_navigate({
                        name:'log',
                        url: '<%= AppServer.cloud_host %>' + '/logmonitor'
                    });
                }
            });

            $('a.local_dash_link').click(function() {
                location.reload();
            });
        });

        //notification settings
        toastr.options = {
            "closeButton": true, "debug": false,
            "positionClass": "toast-top-right",
            "onclick": null, "showDuration": "300",
            "hideDuration": "0", "timeOut": "5000",
            "extendedTimeOut": "1000", "showEasing": "swing",
            "hideEasing": "linear", "showMethod": "fadeIn",
            "hideMethod": "fadeOut"
        };

        var socket = io();
        function setSockets(name) {

            socket.on('progress', function(msg){
                msg = msg + "%";
                $(".progress").show();
                $(".progress-bar").width(msg);
                $('.progress-value').html(msg + " - " + name);
            });
            socket.on('disconnect', function(){
                socket.removeAllListeners('progress');
                socket.removeAllListeners('disconnect');
                $(".progress").hide();
                $('.progress-bar').width(0);
                $('.progress-value').html('');
            });
        }

        socket.on('broadband_update', function(isUp){
            if(isUp === true) {
                $('#status_broadband').addClass('glyphicon-cloud');
                $('#status_broadband').removeClass('glyphicon-warning-sign');
                $('#status_broadband').attr('title','Broadband Up');
            } else {
                $('#status_broadband').addClass('glyphicon-warning-sign');
                $('#status_broadband').removeClass('glyphicon-cloud');
                $('#status_broadband').attr('title','Broadband Down');
            }
        });

        socket.on('cash_balance', function(in_balance){
            if(in_balance === true) {
                $('#cash_balance_status').addClass('green');
                $('#cash_balance_status').removeClass('red');
                $('#cash_balance_status').attr('title','Cash in Balance');
            } else {
                $('#cash_balance_status').addClass('red');
                $('#cash_balance_status').removeClass('green');
                $('#cash_balance_status').attr('title','Cash out of Balance');
            }
        });

        socket.on('alerts', function(alerts){
			var nsn = parseInt($("#nsn").html());
            if (nsn > 0) {
				alerts = alerts.filter(function(ele) {
					return ele.nsn === nsn;
				});

				if(alerts.length > 0) {
                    $('#status_notice').addClass('red');
                    $('#status_notice').removeClass('black');
                    $('#status_notice').attr('title','Pending Notices');
                } else {
                    $('#status_notice').addClass('black');
                    $('#status_notice').removeClass('red');
                    $('#status_notice').attr('title','No Pending Notices');
                }
            }
        });

        /**
         * Display an eBOS Modal, populated with a view pulled via AJAX
         * @param  {object} options
         * @param  {string} options.modal - Selector for the modal div itself
         * @param  {string} options.modalBody - Selector for div where AJAX data should be inserted
         * @param  {string} options.url - URL, passed directly to $.ajax
         * @param  {string} [options.method=GET] - HTTP verb, as accepted by $.ajax
         * @param  {object} [options.headers] - Key+Value store of HTTP headers
         */
        function ebosAjaxModal(options) {
            if (!options) {
                throw Error("options argument must be provided");
            }

            var args = {
                modal: undefined,
                modalBody: undefined,
                url: undefined,
                method: 'GET',
                headers: {
                    'X-User-Language': $('html')[0].lang
                }
            };

            $.extend(true, args, options); // deep merge so headers are preserved

            if (!args.modal || !args.modalBody || !args.url) {
                throw Error("modalID, modalBodyID, and url must have values");
            }

            $.ajax({
                url: args.url,
                type: args.method,
                headers: args.headers,
                success: function(data) {
                    $(args.modalBody).html(data);
                    $(args.modal).modal('show');
                },
                error: function(err) {
                    handler.error(err);
                }
            });
        }

        function showStatusModal(){
            return ebosAjaxModal({
                modal: '#cash_balance_modal',
                modalBody: '#cash_balance_modal_body',
                url: '/cash/balance'
            });
        }

        function showAlertsModal(){
            return ebosAjaxModal({
                modal: '#alerts_modal',
                modalBody: '#alerts_modal_body',
                url: '/alerts/modal?user=awk'
            });
        }

		function statusNoticeClick() {
			var nsn = parseInt($("#nsn").html());
            if (nsn > 0) {
				showAlertsModal();
			}
		}
    </script>
</head>
<body>
<div class="status-bar" >
    <div class="container" >
        <div class="row">
            <div id='status1_status' class="col-xs-4">
                <div class="progress">
                    <span class="progress-value"></span>
                    <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
            <div id='status2_status' class="col-xs-4"></div>
            <div id='status3_status' class="col-xs-2"></div>
            <div id='status_icons' class="status_icons col-xs-2">
                <span id='cash_balance_status' title='Cash Balance' class='status_icon glyphicon glyphicon-usd green' onclick="showStatusModal();"></span>
                <span id='status_notice' title='Notices'
                	class='status_icon glyphicon glyphicon-exclamation-sign' onclick="statusNoticeClick();"></span>
                <!--<span id='status_info' title='Informational
                	Messages' class='status_icon glyphicon
					glyphicon-info-sign'></span>-->
                <span id='status_broadband' class='status_icon glyphicon glyphicon-cloud'></span>
                <span id='status_help' title='Help' class='status_icon glyphicon glyphicon-question-sign'></span>
            </div>
        </div>
    </div>
</div>
<nav id="myNavbar" class="navbar navbar-default navbar-fixed-top navbar-affix" role="navigation">
    <div class="container">
        <!~~ Brand and toggle get grouped for better mobile display ~~>
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="local_dash_link navbar-brand" ><%=: 'profitability' | translate %>&nbsp;&nbsp;
                <div style='color: rgba(10,10,10, .8); float: right; min-width: 50px;' id='nsn'></div>
            </a>
        </div>

        <!~~ Collect the nav links, forms, and other content for toggling ~~>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav">
                <li class="dropdown">
                    <a href="#" class="add_nsn dropdown-toggle"><%=: 'inventory' | translate %> <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        <% // TODO FIXME rewrite all these inline onClicks as proper functions like cash links are %>
                        <li><a onClick="javascript:ebos_navigate('name', '<%= AppServer.inv_host %>' + '/inv/' + $('#nsn').html() + '/count');"><%=: 'physinv' | translate %></a></li>
                        <li><a onClick="javascript:ebos_navigate('name', '<%= AppServer.inv_host %>' + '/inv/' + $('#nsn').html() + '/purchase');">Purchases</a></li>
                        <li><a onClick="javascript:ebos_navigate('name', '<%= AppServer.inv_host %>' + '/inv/' + $('#nsn').html() + '/rawwaste?start_date=' + moment().startOf('M').format('YYYY-MM-DD') );">Promotions & Waste</a></li>
                        <li><a onClick="javascript:ebos_navigate('name', '<%= AppServer.inv_host %>' + '/inv/' + $('#nsn').html() + '/raw_detail');">Raw Item Activity</a></li>
                        <li><a onClick="javascript:ebos_navigate('name', '<%= AppServer.inv_host %>' + '/inv/' + $('#nsn').html() + '/raw_info');">Raw Item Information</a></li>
                        <li><a onClick="javascript:ebos_navigate('name', '<%= AppServer.inv_host %>' + '/inv/' + $('#nsn').html() + '/transfers?start_date=' + moment().startOf('M').format('YYYY-MM-DD') + '&end_date=' + moment().format('YYYY-MM-DD'));">Transfers</a></li>
                        <li><a onClick="javascript:ebos_navigate('name', '<%= AppServer.inv_host %>' + '/inv/' + $('#nsn').html() + '/manual_vendors');"><%=: 'manual_vendors' | translate %></a></li>

                    </ul>
                </li>
                <li class="dropdown">
                    <a href="#" class="add_nsn dropdown-toggle"><%=: 'cash' | translate %> <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        <li class='local_cash_link disabled'><a class='local_cash_link disabled'><%=: 'drawer_countdown' | translate %></a>
                        </li>
                        <li class='local_qa_link disabled'>
                            <a class='local_qa_link disabled'>Local Data Sync</a>
                        </li>
                        <li class='local_safe_link'>
                            <a class='local_safe_link'><%=: 'safe_count' | translate %></a>
                        </li>

                        <li class="divider"></li>

                        <li class='local_safe_count_link'>
                            <a class='local_safe_count_link'>Safe Count V2 (temp)</a>
                        </li>

                        <li class='local_skims_link'>
                            <a class='local_skims_link'><%=: 'skims' | translate %></a>
                        </li>
                        <li class='local_deposits_link'>
                            <a class='local_deposits_link'><%=: 'deposits' | translate %></a>
                        </li>
                        <li class='local_crime_losses_link'>
                            <a class='local_crime_losses_link'><%=: 'crime_losses' | translate %></a>
                        </li>
                        <li class='local_deposit_validation_link'>
                            <a class='local_deposit_validation_link'><%=: 'deposit_validation' | translate %></a>
                         </li>
                        <li class='local_cash_controls_link'>
                            <a class='local_cash_controls_link'><%=: 'store_control_settings' | translate %></a>                        <li>
                        </li>
                        <li><a onClick="javascript:ebos_navigate('name', '<%= AppServer.cash_host %>' + '/cash/' + $('#nsn').html() + '/billable_sales');"><%=: 'billable_sales' | translate %></a></li>

                    </ul>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li class="dropdown">
                    <a href="#" data-toggle="dropdown" class="dropdown-toggle"><%=: 'store' | translate %> <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        <li><a class="ebos_url" href="#">762</a></li>
                        <li><a class="ebos_url" href="#">7320</a></li>
                        <li><a class="ebos_url" href="#">11078</a></li>
                        <li class="divider"></li>
                        <li><a class="ebos_url" href="#">1422</a></li>
                        <li><a class="ebos_url" href="#">1532</a></li>
                        <li><a class="ebos_url" href="#">10776</a></li>
                        <li><a class="ebos_url" href="#">11089</a></li>
                        <li><a class="ebos_url" href="#">28858</a></li>
                    </ul>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li class='local_log_link disabled'>
                    <a class='local_log_link disabled' ><%=: 'log_monitor' | translate %></a>
                </li>
            </ul>
        </div><!~~ /.navbar-collapse ~~>
    </div>
</nav><!-- End navbar container block -->

<!--STATUS MODAL - used for cash balance, should extend in future for other notifications-->
<div class="modal fade" id="cash_balance_modal" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <b class="modal-title" id="">Cash Balance</b>
                <button type="button" class="close" data-dismiss="modal" id="">
                    <span aria-hidden="true">&times;</span><span class="sr-only">Close</span>
                </button>
            </div>
            <div class="modal-body" id="cash_balance_modal_body">
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="alerts_modal" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <b class="modal-title" id="">Pending Alerts</b>
                <button type="button" class="close" data-dismiss="modal" id="">
                    <span aria-hidden="true">&times;</span><span class="sr-only">Close</span>
                </button>
            </div>
            <div class="modal-body" id="alerts_modal_body">
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>
<!-- END STATUS MODAL - used for cash balance, should extend in future for other notifications-->

<!-- The following 3 divs are closed by footer.ejs -->
<div id='main_content' class="main_content container">
    <div class="app_content_row row">
        <div id='app_content' class="app_content col-xs-12">
